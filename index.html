<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Продажа каннабиса</title>
  <!-- Подключение шрифтов -->
  <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@400;700&display=swap" rel="stylesheet">
  
  <!-- Подключение Firebase (версия 8.x, можно использовать и 9 modular, но здесь классический синтаксис) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  
  <style>
    /* Общие стили */
    body {
      font-family: 'Comfortaa', sans-serif;
      background-color: #121212;
      color: #E0E0E0;
      margin: 0;
      padding: 20px;
      text-align: center;
      transition: all 0.3s ease-in-out;
    }
    .header {
      margin-bottom: 40px;
    }
    .header h1 {
      font-size: 2.5em;
      margin: 0;
      color: #BB86FC;
      text-shadow: 0px 0px 15px #BB86FC;
    }
    .header p {
      font-size: 1.2em;
      color: #CF6679;
      text-shadow: 0px 0px 10px #CF6679;
    }
    .stats {
      display: flex;
      justify-content: space-around;
      margin-bottom: 40px;
    }
    .stat {
      background: #1F1B24;
      padding: 20px;
      border-radius: 10px;
      width: 45%;
      box-shadow: 0px 0px 15px rgba(187, 134, 252, 0.5);
      transition: all 0.3s ease-in-out;
    }
    .stat:hover {
      transform: scale(1.05);
    }
    /* Обёртка для дней – с обратным порядком (от последней даты к первой) */
    .days-container {
      display: flex;
      flex-direction: column-reverse;
    }
    /* Стили для блока дня */
    .day-container {
      margin-bottom: 10px;
    }
    .date-item {
      background: #1F1B24;
      padding: 15px;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease-in-out;
      box-shadow: 0px 0px 10px rgba(255, 255, 255, 0.2);
      margin-bottom: 5px;
    }
    .date-item:hover {
      background: #BB86FC;
      box-shadow: 0px 0px 15px #BB86FC;
    }
    /* Отступ сверху для таблицы внутри блока дня */
    .day-container .strain-list {
      margin-top: 20px;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-in-out;
    }
    /* Таблица с закруглёнными углами */
    table {
      width: 90%;
      margin: 0 auto;
      border-collapse: separate;
      border-spacing: 0;
      background: #1F1B24;
      color: #E0E0E0;
      border-radius: 10px;
      overflow: hidden;
    }
    th, td {
      border: 1px solid #333;
      padding: 10px;
      text-align: center;
    }
    th {
      background-color: #2A2733;
    }
    /* Таблица состоит из 5 столбцов */
    td.sum-cell {
      position: relative;
    }
    /* Стили для кнопки удаления */
    .delete-btn {
      position: absolute;
      right: 5px;
      top: 50%;
      transform: translateY(-50%);
      width: 32px;
      height: 32px;
      background: transparent;
      border: none;
      cursor: pointer;
      outline: none;
    }
    .delete-btn::before,
    .delete-btn::after {
      content: "";
      position: absolute;
      top: 50%;
      left: 50%;
      width: 20px;
      height: 3px;
      background-color: #CF6679;
      transition: transform 0.3s ease;
    }
    .delete-btn::before {
      transform: translate(-50%, -50%) rotate(45deg);
    }
    .delete-btn::after {
      transform: translate(-50%, -50%) rotate(-45deg);
    }
    .delete-btn:hover::before {
      transform: translate(-50%, -50%) rotate(135deg);
    }
    .delete-btn:hover::after {
      transform: translate(-50%, -50%) rotate(-135deg);
    }
    /* Стили для обычных кнопок */
    button.action {
      margin-top: 10px;
      padding: 10px 20px;
      background: #BB86FC;
      border: none;
      border-radius: 5px;
      color: #121212;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    button.action:hover {
      background: #a053ff;
    }
  </style>
  
  <script>
    // 1. Инициализация Firebase
    // Замените объект firebaseConfig своими данными из Firebase Console!
    var firebaseConfig = {
      apiKey: "AIzaSyATvHD_APbLIxAkGYx8f4sDwzCLdhGjp5Q",
      authDomain: "dasdd-c69a8.firebaseapp.com",
      databaseURL: "https://dasdd-c69a8.firebaseapp.com",
      projectId: "dasdd-c69a8",
      storageBucket: "dasdd-c69a8.firebasestorage.app",
      messagingSenderId: "1028613232560",
      appId: "1:1028613232560:web:fcf8e82cb0b5aebb806875"
    };
    // Инициализируем Firebase
    firebase.initializeApp(firebaseConfig);
    var database = firebase.database();
    
    /* Функция, разрешающая ввод только цифр */
    function isNumberKey(evt) {
      var charCode = (evt.which) ? evt.which : evt.keyCode;
      // Разрешаем управляющие клавиши (backspace, tab, enter, escape, стрелки)
      if (charCode === 8 || charCode === 9 || charCode === 13 || charCode === 27 ||
    (charCode >= 37 && charCode <= 40)) {
  return true;
}
      if (charCode < 48 || charCode > 57) {
        evt.preventDefault();
        return false;
      }
      return true;
    }
    
    /* Функция для копирования общего дохода (опционально) */
    function copyOverallIncome() {
      var incomeText = document.getElementById("overall-income").innerText;
      navigator.clipboard.writeText(incomeText).then(function() {
        var elem = document.getElementById("overall-income");
        elem.style.color = "#BB86FC";
        elem.style.textShadow = "0 0 15px #BB86FC";
        setTimeout(function() {
          elem.style.color = "#E0E0E0";
          elem.style.textShadow = "none";
        }, 1000);
      }).catch(function(err) {
        console.error('Ошибка при копировании: ', err);
      });
    }
    
    /* Функция показа/скрытия таблицы для дня */
    function toggleStrains(idTable) {
      var container = document.getElementById(idTable);
      if (container.style.maxHeight === "0px" || container.style.maxHeight === "") {
        container.style.maxHeight = container.scrollHeight + "px";
      } else {
        container.style.maxHeight = "0px";
      }
    }
    
    /* Функция обновления суммы в строке и дохода за день */
    function updateRowSum(cell, dayNum) {
      var row = cell.parentElement;
      var green  = parseFloat(row.cells[1].innerText) || 0;
      var yellow = parseFloat(row.cells[2].innerText) || 0;
      var red    = parseFloat(row.cells[3].innerText) || 0;
      var sum = green + yellow + red;
      row.cells[4].querySelector('.sum-value').innerText = sum;
      updateDayIncome(dayNum);
    }
    
    /* Обновление дохода за день – суммируются все значения столбца "Сумма" */
    function updateDayIncome(dayNum) {
      var table = document.getElementById("dataTable-" + dayNum);
      var total = 0;
      for (var i = 1; i < table.rows.length; i++) {
        var row = table.rows[i];
        total += parseFloat(row.querySelector('.sum-value').innerText) || 0;
      }
      var dateItem = document.getElementById("date-item-" + dayNum);
      var dayLabel = dateItem.getAttribute("data-date");
      dateItem.innerText = dayLabel + " - " + total + " бат";
      dateItem.setAttribute("data-income", total);
      updateOverallIncome();
    }
    
    /* Обновление общего дохода (сумма доходов всех дней) */
    function updateOverallIncome() {
      var dayItems = document.querySelectorAll(".date-item");
      var overall = 0;
      dayItems.forEach(function(item) {
        overall += parseFloat(item.getAttribute("data-income")) || 0;
      });
      document.getElementById("overall-income").innerText = overall + " бат";
    }
    
    /* Функция добавления новой строки в таблицу дня */
    function addRow(dayNum) {
      var tbody = document.getElementById("tableBody-" + dayNum);
      var newRow = document.createElement("tr");
      newRow.innerHTML = `
        <td contenteditable="true">Новый сорт</td>
        <td contenteditable="true" onkeypress="return isNumberKey(event)" onblur="updateRowSum(this, '${dayNum}')">0</td>
        <td contenteditable="true" onkeypress="return isNumberKey(event)" onblur="updateRowSum(this, '${dayNum}')">0</td>
        <td contenteditable="true" onkeypress="return isNumberKey(event)" onblur="updateRowSum(this, '${dayNum}')">0</td>
        <td class="sum-cell">
          <span class="sum-value">0</span>
          <button class="delete-btn" onclick="deleteRow(this, '${dayNum}')"></button>
        </td>
      `;
      tbody.appendChild(newRow);
      var container = document.getElementById("strains-" + dayNum);
      if (container.style.maxHeight !== "0px" && container.style.maxHeight !== "") {
        container.style.maxHeight = container.scrollHeight + "px";
      }
      updateDayIncome(dayNum);
    }
    
    /* Удаление строки из таблицы дня */
    function deleteRow(btn, dayNum) {
      var row = btn.closest("tr");
      row.parentElement.removeChild(row);
      var container = document.getElementById("strains-" + dayNum);
      if (container.style.maxHeight !== "0px" && container.style.maxHeight !== "") {
        container.style.maxHeight = container.scrollHeight + "px";
      }
      updateDayIncome(dayNum);
    }
    
    /* Сохранение данных таблицы дня в Firebase */
    function saveTable(dayNum) {
      var table = document.getElementById("dataTable-" + dayNum);
      var data = [];
      for (var i = 1; i < table.rows.length; i++) {
        var row = table.rows[i];
        data.push({
          сорт:    row.cells[0].innerText,
          зеленая: row.cells[1].innerText,
          жёлтая: row.cells[2].innerText,
          красная: row.cells[3].innerText,
          сумма:   row.querySelector('.sum-value').innerText
        });
      }
      // Сохраняем данные в Firebase под путём "tables/dayNum"
      database.ref('tables/' + dayNum).set(data)
        .then(function() {
          alert("Данные за день " + dayNum + " сохранены!");
        })
        .catch(function(error) {
          console.error("Ошибка сохранения: ", error);
        });
    }
    
    /* Загрузка данных таблицы дня из Firebase */
    function loadTable(dayNum) {
      database.ref('tables/' + dayNum).once('value')
        .then(function(snapshot) {
          var savedData = snapshot.val();
          if (savedData) {
            var tbody = document.getElementById("tableBody-" + dayNum);
            tbody.innerHTML = "";
            savedData.forEach(function(rowData) {
              var tr = document.createElement("tr");
              tr.innerHTML = `
                <td contenteditable="true">${rowData["сорт"]}</td>
                <td contenteditable="true" onkeypress="return isNumberKey(event)" onblur="updateRowSum(this, '${dayNum}')">${rowData["зеленая"]}</td>
                <td contenteditable="true" onkeypress="return isNumberKey(event)" onblur="updateRowSum(this, '${dayNum}')">${rowData["жёлтая"]}</td>
                <td contenteditable="true" onkeypress="return isNumberKey(event)" onblur="updateRowSum(this, '${dayNum}')">${rowData["красная"]}</td>
                <td class="sum-cell">
                  <span class="sum-value">${rowData["сумма"]}</span>
                  <button class="delete-btn" onclick="deleteRow(this, '${dayNum}')"></button>
                </td>
              `;
              tbody.appendChild(tr);
            });
            updateDayIncome(dayNum);
          }
        })
        .catch(function(error) {
          console.error("Ошибка загрузки данных для дня " + dayNum + ": ", error);
        });
    }
    
    /* Функция для автоматического добавления нового блока для сегодняшней даты */
    function addTodayIfNotExist() {
      // Получаем сегодняшнюю дату в формате "DD MMMM" (например, "07 июля" или "05 февраля")
      var today = new Date();
      var options = { day: 'numeric', month: 'long' };
      var todayStr = today.toLocaleDateString("ru-RU", options);
      
      // Проверяем, есть ли уже date-item с таким значением в data-date
      var exists = false;
      document.querySelectorAll(".date-item").forEach(function(item) {
        if (item.getAttribute("data-date") === todayStr) {
          exists = true;
        }
      });
      
      if (!exists) {
        // Если сегодня ещё нет в списке, создаём новый блок дня
        var daysContainer = document.querySelector(".days-container");
        var newDayContainer = document.createElement("div");
        newDayContainer.className = "day-container";
        // Для идентификаторов используем сегодня в формате YYYYMMDD
        var idDate = today.getFullYear() + ("0"+(today.getMonth()+1)).slice(-2) + ("0"+today.getDate()).slice(-2);
        newDayContainer.innerHTML = `
          <div id="date-item-${idDate}" data-date="${todayStr}" data-income="0" class="date-item" onclick="toggleStrains('strains-${idDate}')">
            ${todayStr} - 0 бат
          </div>
          <div id="strains-${idDate}" class="strain-list">
            <table id="dataTable-${idDate}">
              <thead>
                <tr>
                  <th>Сорта</th>
                  <th>Зеленая</th>
                  <th>Жёлтая</th>
                  <th>Красная</th>
                  <th>Сумма</th>
                </tr>
              </thead>
              <tbody id="tableBody-${idDate}">
                <tr>
                  <td contenteditable="true">Пример сорта</td>
                  <td contenteditable="true" onkeypress="return isNumberKey(event)" onblur="updateRowSum(this, '${idDate}')">0</td>
                  <td contenteditable="true" onkeypress="return isNumberKey(event)" onblur="updateRowSum(this, '${idDate}')">0</td>
                  <td contenteditable="true" onkeypress="return isNumberKey(event)" onblur="updateRowSum(this, '${idDate}')">0</td>
                  <td class="sum-cell">
                    <span class="sum-value">0</span>
                    <button class="delete-btn" onclick="deleteRow(this, '${idDate}')"></button>
                  </td>
                </tr>
              </tbody>
            </table>
            <div>
              <button class="action" onclick="addRow('${idDate}')">Добавить строку</button>
              <button class="action" onclick="saveTable('${idDate}')">Сохранить таблицу</button>
            </div>
          </div>
        `;
        // Добавляем новый день в контейнер дней (flex с column-reverse — он появится сверху)
        daysContainer.appendChild(newDayContainer);
      }
    }
    
    /* При загрузке страницы загружаем данные таблиц для каждого дня и обновляем общий доход */
    window.addEventListener('DOMContentLoaded', function() {
      // Автоматически добавляем блок для сегодняшней даты, если его ещё нет
      addTodayIfNotExist();
      
      // Предположим, что у вас уже есть сохранённые данные для дней с 1 по 7,
      // а также для сегодняшнего дня (если он не совпадает с этими)
      // Вы можете настроить диапазон загрузки по своему усмотрению.
      var days = document.querySelectorAll(".date-item");
      days.forEach(function(item) {
        // Получаем id дня из идентификатора элемента (например, "date-item-20220507" или просто "1")
        var id = item.id.split("-")[2] || item.id.split("-")[1]; 
        loadTable(id);
      });
      updateOverallIncome();
    });
  </script>
</head>
<body>
  <div class="header">
    <h1>Продажа каннабиса</h1>
    <p>Просмотр ежедневных продаж и деталей сортов</p>
  </div>
  <div class="stats">
    <div class="stat" onclick="copyOverallIncome()" style="cursor: pointer; transition: all 0.3s ease;">
      <h2>Общий доход</h2>
      <p id="overall-income">0 бат</p>
    </div>
    <div class="stat">
      <h2>Лучший сорт</h2>
      <p>-</p>
    </div>
  </div>
  <div>
    <h2>Доход по датам:</h2>
    <!-- Оборачиваем все блоки дней в контейнер -->
    <div class="days-container">
      <!-- Здесь будут находиться существующие day-container, загружённые из Firebase, 
           а функция addTodayIfNotExist добавит блок для сегодняшнего дня, если его ещё нет -->
      <!-- Например, если ранее были сохранены данные для дней 1,2,3,4,5,6,7, они отобразятся здесь. -->
    </div>
  </div>
</body>
</html>
